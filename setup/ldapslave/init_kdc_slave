#!/usr/bin/ruby

#require 'rubygems'
require 'fileutils'
require 'highline/import'

def get_password(prompt="Kerberos master password")
  ask(prompt) {|q| q.echo = false}
end

Sentinel_file = '/etc/krb5kdc/init_kdc_slave_done'

if File.exist?(Sentinel_file) and not ARGV[0] == '--force'
  puts "#{ Sentinel_file } exists, use the --force, Mikko!"
  exit 1
end

@binddn        = File.read('/etc/puavo/ldap/dn'       ).chomp
@bindpw        = File.read('/etc/puavo/ldap/password' ).chomp

@kerberos_masterpw = get_password()

File.delete("/etc/krb5kdc/stash") if File.exists?("/etc/krb5kdc/stash")
File.delete("/etc/krb5.secrets") if File.exists?("/etc/krb5.secrets")
File.delete("/etc/krb5.keytab") if File.exists?("/etc/krb5.keytab")
File.delete("/etc/ldap/krb5.keytab") if File.exists?("/etc/ldap/krb5.keytab")

`echo "#{@bindpw}\\n#{@bindpw}\\n" | /usr/sbin/kdb5_ldap_util stashsrvpw -f /etc/krb5.secrets "#{@binddn}" 2>/dev/null`

puts `echo "#{@kerberos_masterpw}" | kadmin.local -m -q "ktadd -norandkey -k /etc/krb5kdc/stash K/M"`
`/etc/init.d/krb5-kdc restart`

FileUtils.touch(Sentinel_file)
