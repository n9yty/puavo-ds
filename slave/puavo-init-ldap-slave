#!/usr/bin/ruby

require 'erb'
require 'fileutils'
require 'getoptlong'
require 'tempfile'

use_force = false
update_only_config = false

opts = GetoptLong.new(
  ['--help', '-h', GetoptLong::NO_ARGUMENT],
  ['--force', GetoptLong::NO_ARGUMENT],
  ['--update-only-config', GetoptLong::NO_ARGUMENT]
)

opts.each do |opt, arg|
  case opt
  when '--help'
    puts <<EOF
Usage: puavo-init-ldap-slave [OPTION]...

Configure and initialize slapd.

-h, --help                       display this help and exit
    --force                      clear and re-initialize the database
    --update-only-config         update only cn=config and restart slapd

EOF
    exit(0)
  when '--force'
    use_force = true
  when '--update-only-config'
    update_only_config = true
  end
end

if ARGV.length != 0 then
  STDERR.puts("error: invalid number of arguments #{ARGV.length}, expected 0")
  exit(1)
end

# Use SSL certificate that was acquired when the host was
# registered to Puavo.
ENV["LDAPTLS_REQCERT"] = "demand"
ENV["LDAPTLS_CACERT"] = "/etc/puavo/certs/rootca.pem"

Sentinel_file = '/var/lib/ldap/init_ldap_slave_done'

if !File.exist?(Sentinel_file) and update_only_config
  STDERR.puts('error: failed to update uninitialized slapd')
  STDERR.puts('  Run again without --update-only-config to initialize it.')
  exit(1)
end

if File.exist?(Sentinel_file) and not use_force
  puts "#{ Sentinel_file } exists, use the --force, Mikko!"
  exit 1
end

@binddn        = File.read('/etc/puavo/ldap/dn'      ).chomp
@bindpw        = File.read('/etc/puavo/ldap/password').chomp
@master_server = File.read('/etc/puavo/ldap/master'  ).chomp
@suffix        = File.read('/etc/puavo/ldap/base'    ).chomp

def parse_erb(basename)
  ldif_template = File.read("/usr/share/puavo-ds-slave/#{ basename }.ldif.erb")
  ldif = ERB.new(ldif_template, 0, "%<>")

  tempfile = Tempfile.open(basename)
  tempfile.puts ldif.result
  tempfile.close
  
  tempfile
end

system('service slapd stop')
sleep 3
system('pkill -9 -x slapd')

system('rm -rf /etc/ldap/slapd.d/*') \
  or raise 'could not remove old ldap configuration'

@acls = `ldapsearch -LLL -x -H ldap://#{ @master_server } -D #{ @binddn } -w #{ @bindpw } -Z -b cn=config "(&(objectClass=olcDatabaseConfig)(olcSuffix=#{ @suffix }))" olcAccess | grep -v dn:`
if $?.exitstatus != 0
  raise 'Problem in getting acls from master server'
end

@schemas = `ldapsearch -LLL -x -H ldap://#{ @master_server } -D #{ @binddn } -w #{ @bindpw } -Z -b cn=schema,cn=config`
if $?.exitstatus != 0
  raise 'Problem in getting schemas from master server'
end

tempfile = parse_erb('init_ldap_slave')
system("slapadd -l #{tempfile.path} -F /etc/ldap/slapd.d -b 'cn=config'") \
  or raise 'Problem in making ldap configuration'

system('chown -R openldap.openldap /etc/ldap/slapd.d') \
  or raise 'could not chown /etc/ldap/slapd.d to openldap user'

if update_only_config
  system('service slapd start') \
    or raise 'slapd start failed'
  exit(0)
end

system('rm -rf /var/lib/ldap/*') \
  or raise 'could not remove old ldap database'

system('chown -R openldap.openldap /var/lib/ldap') \
  or raise 'could not chown /var/lib/ldap to openldap user'

system('install -m 0644 -g openldap /etc/puavo/certs/host.crt /etc/ssl/certs/slapd-server.crt') \
  or raise "could not install /etc/puavo/certs/host.crt to /etc/ssl/certs/slapd-server.crt"

system('install -m 0640 -g openldap /etc/puavo/certs/host.key /etc/ssl/certs/slapd-server.key') \
  or raise "could not copy /etc/puavo/certs/host.key to /etc/ssl/certs/slapd-server.key"

system('install -m 0644 -g openldap /etc/puavo/certs/orgcabundle.pem /etc/ssl/certs/slapd-ca.crt') \
  or raise "could not copy /etc/puavo/certs/orgcabundle.pem to /etc/ssl/certs/slapd-ca.crt"

system('chmod -R 0750 /var/lib/ldap') \
  or raise 'could not chmod /var/lib/ldap'

system('service slapd start') \
  or raise 'slapd start failed'

FileUtils.touch(Sentinel_file)

puts 'Waiting for slapd to sync all data from ldap master.'
puts 'This may take a while.'

previous_linecount = -1
current_linecount = 0
while previous_linecount != current_linecount
  if current_linecount > 0 then
    puts "Still waiting... the magic number is #{current_linecount} now."
  end

  sleep 10
  previous_linecount = current_linecount
  IO::popen("slapcat") do |io|
    current_linecount = io.readlines().count
    io.close()
    $?.success? or raise 'failed to query the database contents'
  end
end

puts 'LDAP database in now in sync.'
puts
